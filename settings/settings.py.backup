"""
Settings Management Module

This module provides UI for managing:
1. LLM Models and API Keys (add/edit/delete)
2. Company Details (name, UEN, address, logo, templates)

Author: Wong Xin Ping
Date: 18 September 2025
"""

import streamlit as st
import json
import os
import shutil
from datetime import datetime
from typing import Dict, List, Any
import base64
from PIL import Image
import io

# Import existing configurations
from settings.model_configs import MODEL_CHOICES
from settings.api_manager import load_api_keys, save_api_keys, load_custom_models, save_custom_models, add_custom_model, remove_custom_model, delete_api_key
from generate_ap_fg_lg_lp.utils.organizations import get_organizations, save_organizations

def app():
    """Main settings application"""
    st.title("‚öôÔ∏è Settings")

    # Force refresh of models on settings page load
    if st.button("üîÑ Refresh Models", help="Click to refresh the model list if custom models aren't showing"):
        # Clear relevant session state
        if 'custom_models' in st.session_state:
            del st.session_state['custom_models']
        if 'api_keys' in st.session_state:
            del st.session_state['api_keys']
        st.rerun()

    # API & LLM Models section
    st.subheader("ü§ñ API & LLM Models")
    manage_llm_settings()

    st.markdown("---")  # Divider between sections

    # Company Management section
    st.subheader("üè¢ Company Management")
    manage_company_settings()

def llm_settings_app():
    """API & LLM Models page"""
    st.title("ü§ñ API & LLM Models")
    manage_llm_settings()

def company_management_app():
    """Company Management page"""
    st.title("üè¢ Company Management")
    manage_company_settings()

def manage_llm_settings():
    """Manage LLM Models and API Keys"""
    
    # Create sub-tabs for API Keys and Custom Models
    api_tab, models_tab = st.tabs(["üîë API Keys", "ü§ñ Custom Models"])
    
    with api_tab:
        manage_api_keys()
    
    with models_tab:
        manage_custom_models()

def manage_api_keys():
    """Manage API Keys section"""
    st.subheader("API Keys Management")
    
    st.info("üí° Add your API keys here to use different LLM providers. Keys are stored securely and used dynamically.")
    
    
    # Load current API keys
    current_keys = load_api_keys()
    
    updated_keys = {}
    
    # Display all providers in a single section
    st.write("### API Keys")
    
    # Sort keys for consistent display
    sorted_keys = sorted(current_keys.keys())
    
    for key in sorted_keys:
        provider_name = key.replace("_API_KEY", "").replace("_", " ").title()

        # Create columns for API key input and delete button
        col1, col2 = st.columns([4, 1])

        with col1:
            updated_keys[key] = st.text_input(
                f"{provider_name} API Key",
                value=current_keys[key],
                type="password",
                help=f"Enter your {provider_name} API key",
                key=f"api_key_{key}"
            )

        with col2:
            st.write("") # Empty space for alignment
            if st.button(f"üóëÔ∏è", key=f"delete_{key}", help=f"Delete {provider_name} API Key"):
                if delete_api_key(key):
                    st.success(f"‚úÖ Deleted {provider_name} API Key!")
                    st.rerun()
                else:
                    st.error(f"‚ùå Error deleting {provider_name} API Key")
    
    # Add new API key section
    st.write("### Add New API Key")
    col1, col2 = st.columns([2, 1])
    
    with col1:
        new_provider_name = st.text_input(
            "Provider Name",
            placeholder="e.g., CUSTOM_PROVIDER",
            help="Enter the name of the new API provider (will be converted to PROVIDER_API_KEY format)"
        )
    
    with col2:
        new_api_key = st.text_input(
            "API Key",
            type="password",
            placeholder="Enter API key"
        )
    
    if st.button("‚ûï Add New API Key"):
        if new_provider_name and new_api_key:
            # Format the key name
            formatted_key = f"{new_provider_name.upper().replace(' ', '_')}_API_KEY"
            
            if formatted_key not in current_keys:
                # Add to current keys and save immediately
                current_keys[formatted_key] = new_api_key
                if save_api_keys(current_keys):
                    st.success(f"‚úÖ Added and saved new API key: {formatted_key}")
                    st.rerun()
                else:
                    st.error("‚ùå Error saving new API key")
            else:
                st.warning(f"API key {formatted_key} already exists!")
        else:
            st.error("Please provide both provider name and API key")
    
    # Save API Keys
    if st.button("üíæ Save API Keys", type="primary"):
        if save_api_keys(updated_keys):
            st.success("‚úÖ API Keys saved successfully!")
            st.rerun()
        else:
            st.error("‚ùå Error saving API Keys. Please try again.")

def manage_custom_models():
    """Manage Custom Models section"""
    st.subheader("Custom Models Management")
    
    # Display current models
    from settings.api_manager import get_all_available_models
    all_models = get_all_available_models()
    custom_models = load_custom_models()
    
    # Show all available models
    st.subheader("All Available Models")
    model_df_data = []
    for model_name, config in all_models.items():
        is_custom = any(m["name"] == model_name for m in custom_models)
        model_info = {
            "Model": model_name,
            "Type": "Custom" if is_custom else "Built-in",
            "Provider": config["provider"],
            "Base Model": config["config"].get("model", "N/A"),
            "Temperature": config["config"].get("temperature", "N/A"),
            "Has API Key": "‚úÖ" if config["config"].get("api_key") else "‚ùå"
        }
        model_df_data.append(model_info)
    
    st.dataframe(model_df_data, use_container_width=True)
    
    # Add new custom model
    st.subheader("Add Custom Model")
    
    # Show examples
    with st.expander("üìù Examples of Custom Models", expanded=False):
        st.markdown("""
        **Popular Models You Can Add:**
        
        **OpenAI Models:**
        - GPT-4 Turbo: `gpt-4-0125-preview`
        - GPT-4o: `gpt-4o`
        - GPT-4o-mini: `gpt-4o-mini`
        
        **Anthropic Models:**
        - Anthropic Sonnet: `claude-3-sonnet-20240229`
        - Anthropic Haiku: `claude-3-haiku-20240307`
        - Anthropic Sonnet 3.5: `claude-3-5-sonnet-20241022`
        
        **Other Providers:**
        - Groq Llama: `llama3-70b-8192`
        - Together AI: `meta-llama/Llama-2-70b-chat-hf`
        - Ollama: `llama2` (local model)
        - Mistral: `mistral-large-latest`
        """)
    
    with st.form("add_custom_model"):
        col1, col2 = st.columns(2)
        
        with col1:
            model_name = st.text_input("Model Display Name *", placeholder="e.g., GPT-4-Custom")
            model_id = st.text_input("Model ID *", placeholder="e.g., gpt-4-0125-preview")
            temperature = st.slider("Temperature", 0.0, 2.0, 0.2, 0.1)
        
        with col2:
            provider_options = [
                "OpenAIChatCompletionClient",
                "AnthropicChatCompletionClient",
                "GroqChatCompletionClient",
                "CohereClient",
                "TogetherClient",
                "OllamaClient",
                "Custom"
            ]
            provider = st.selectbox("Client Type *", provider_options)
            base_url = st.text_input("Base URL (optional)", placeholder="e.g., https://api.openai.com/v1")

            api_provider_options = [
                "OPENAI", "DEEPSEEK", "GEMINI", "OPENROUTER", "GROQ", "GROK",
                "ANTHROPIC", "COHERE", "HUGGINGFACE", "OLLAMA", "MISTRAL",
                "TOGETHER", "PERPLEXITY", "REPLICATE", "CUSTOM"
            ]
            api_provider = st.selectbox("API Key Provider", api_provider_options)
        
        custom_api_key = ""
        if api_provider == "CUSTOM":
            custom_api_key = st.text_input("Custom API Key", type="password", help="This will be stored with the custom model")

        submitted = st.form_submit_button("‚ûï Add Model", type="primary")

        if submitted:
            if not model_name or not model_id or not provider:
                st.error("‚ùå Please fill in all required fields: Model Display Name, Model ID, and Client Type")
            else:
                st.info(f"üîÑ Adding model '{model_name}'...")
                success = add_custom_model(
                    name=model_name,
                    provider=provider,
                    model_id=model_id,
                    base_url=base_url,
                    temperature=temperature,
                    api_provider=api_provider,
                    custom_api_key=custom_api_key
                )

                if success:
                    st.success(f"‚úÖ Model '{model_name}' added successfully!")
                    # Clear session state to force refresh of models
                    if 'custom_models' in st.session_state:
                        del st.session_state['custom_models']
                    st.rerun()
                else:
                    st.error("‚ùå Failed to add model. Please try again.")
    
    # Remove custom models
    if custom_models:
        st.subheader("Remove Custom Models")
        for model in custom_models:
            col1, col2 = st.columns([3, 1])
            with col1:
                st.markdown(f"**{model['name']}** - {model['config']['model']}")
            with col2:
                if st.button(f"üóëÔ∏è Remove", key=f"remove_{model['name']}"):
                    if remove_custom_model(model['name']):
                        st.success(f"‚úÖ Model '{model['name']}' removed!")
                        # Clear session state to force refresh of models
                        if 'custom_models' in st.session_state:
                            del st.session_state['custom_models']
                        st.rerun()
                    else:
                        st.error("‚ùå Error removing model")

def backup_company_files(company: Dict) -> bool:
    """
    Move company files to backup folder before deletion
    Returns True if successful, False otherwise
    """
    try:
        # Create timestamped backup directory
        timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
        company_name_clean = company['name'].lower().replace(' ', '_').replace('/', '_').replace('\\', '_')
        backup_dir = f"common/deleted_companies/{timestamp}_{company_name_clean}"
        os.makedirs(backup_dir, exist_ok=True)

        files_moved = []

        # Backup logo file
        logo_path = company.get('logo', '')
        if logo_path and os.path.exists(logo_path):
            logo_backup_dir = os.path.join(backup_dir, 'logo')
            os.makedirs(logo_backup_dir, exist_ok=True)
            logo_filename = os.path.basename(logo_path)
            backup_logo_path = os.path.join(logo_backup_dir, logo_filename)
            shutil.move(logo_path, backup_logo_path)
            files_moved.append(f"Logo: {logo_path} ‚Üí {backup_logo_path}")

        # Backup template files
        templates = company.get('templates', {})
        if templates:
            template_backup_dir = os.path.join(backup_dir, 'templates')
            os.makedirs(template_backup_dir, exist_ok=True)

            for template_type, template_path in templates.items():
                if template_path and os.path.exists(template_path):
                    template_filename = os.path.basename(template_path)
                    backup_template_path = os.path.join(template_backup_dir, template_filename)
                    shutil.move(template_path, backup_template_path)
                    files_moved.append(f"{template_type}: {template_path} ‚Üí {backup_template_path}")

        # Remove empty template directory if it exists
        template_dir = f"common/templates/{company_name_clean}"
        if os.path.exists(template_dir) and not os.listdir(template_dir):
            os.rmdir(template_dir)

        # Create a metadata file in backup folder
        metadata = {
            "company_name": company['name'],
            "uen": company.get('uen', ''),
            "deleted_at": timestamp,
            "files_moved": files_moved
        }

        metadata_path = os.path.join(backup_dir, 'backup_metadata.json')
        with open(metadata_path, 'w') as f:
            json.dump(metadata, f, indent=2)

        return True

    except Exception as e:
        st.error(f"Error backing up company files: {e}")
        return False

def manage_company_settings():
    """Manage Company Details"""

    # Load current organizations
    try:
        organizations = get_organizations()
    except:
        organizations = []

    # Create tabs for Edit and Add Company
    edit_tab, add_tab = st.tabs(["‚úèÔ∏è Edit Company", "‚ûï Add New Company"])

    with edit_tab:
        st.subheader("Select Company to Edit")

        if organizations:
            company_names = [org["name"] for org in organizations]
            selected_company_idx = st.selectbox(
                "Choose a company:",
                range(len(company_names)),
                format_func=lambda x: company_names[x],
                index=0  # Always default to first company
            )

            if selected_company_idx is not None and selected_company_idx < len(organizations):
                edit_company_form(organizations, selected_company_idx)
        else:
            st.info("No companies found. Add a new company in the 'Add New Company' tab.")

    with add_tab:
        st.subheader("Add New Company")
        add_company_form(organizations)

def edit_company_form(organizations: List[Dict], company_idx: int):
    """Form to edit existing company"""
    company = organizations[company_idx]
    
    st.subheader(f"Edit: {company['name']}")
    
    with st.form(f"edit_company_{company_idx}"):
        # Company details
        new_name = st.text_input("Company Name", value=company["name"])
        new_uen = st.text_input("UEN", value=company["uen"])
        new_address = st.text_area("Address", value=company.get("address", ""))
        
        # Logo upload
        st.write("Company Logo")
        current_logo_path = company.get("logo", "")
        
        if current_logo_path and os.path.exists(current_logo_path):
            try:
                image = Image.open(current_logo_path)
                st.image(image, caption="Current Logo", width=200)
            except:
                st.warning("Could not display current logo")
        
        uploaded_logo = st.file_uploader(
            "Upload new logo (optional)",
            type=['png', 'jpg', 'jpeg'],
            help="Leave empty to keep current logo"
        )
        
        # Template management
        st.write("Templates")
        templates = company.get("templates", {})
        
        col1, col2 = st.columns(2)
        with col1:
            st.write("**Course Proposal Template**")
            if templates.get("course_proposal"):
                st.success(f"‚úÖ Current: {templates.get('course_proposal').split('/')[-1]}")
            cp_template_file = st.file_uploader("Upload Course Proposal Template", type=['docx', 'doc'], key=f"cp_template_{company_idx}")
            
            st.write("**Assessment Template**")
            if templates.get("assessment"):
                st.success(f"‚úÖ Current: {templates.get('assessment').split('/')[-1]}")
            assessment_template_file = st.file_uploader("Upload Assessment Template", type=['docx', 'doc'], key=f"assessment_template_{company_idx}")
            
        with col2:
            st.write("**Courseware Template**")
            if templates.get("courseware"):
                st.success(f"‚úÖ Current: {templates.get('courseware').split('/')[-1]}")
            courseware_template_file = st.file_uploader("Upload Courseware Template", type=['docx', 'doc'], key=f"courseware_template_{company_idx}")
            
            st.write("**Brochure Template**")
            if templates.get("brochure"):
                st.success(f"‚úÖ Current: {templates.get('brochure').split('/')[-1]}")
            brochure_template_file = st.file_uploader("Upload Brochure Template", type=['docx', 'doc'], key=f"brochure_template_{company_idx}")
        
        # Submit button
        submitted = st.form_submit_button("üíæ Update Company", type="primary")
        
        if submitted:
            # Update company data
            updated_company = {
                "name": new_name,
                "uen": new_uen,
                "address": new_address,
                "logo": company["logo"],  # Keep existing logo path initially
                "templates": company.get("templates", {})  # Keep existing templates initially
            }
            
            # Handle logo upload
            if uploaded_logo:
                logo_path = save_company_logo(uploaded_logo, new_name)
                if logo_path:
                    updated_company["logo"] = logo_path
            
            # Handle template uploads
            template_files = {
                "course_proposal": cp_template_file,
                "courseware": courseware_template_file,
                "assessment": assessment_template_file,
                "brochure": brochure_template_file
            }
            
            for template_type, template_file in template_files.items():
                if template_file:
                    template_path = save_company_template(template_file, new_name, template_type)
                    if template_path:
                        updated_company["templates"][template_type] = template_path
            
            # Update the organization in the list
            organizations[company_idx] = updated_company

            # Save to file
            if save_organizations(organizations):
                st.success(f"‚úÖ Company '{new_name}' updated successfully!")
                # Clear cache to refresh sidebar company list
                st.cache_data.clear()
                st.rerun()
            else:
                st.error("‚ùå Error updating company. Please try again.")
    
    # Delete company button (separate from form)
    delete_button_pressed = st.button(f"üóëÔ∏è Delete {company['name']}", type="secondary")

    if delete_button_pressed:
        if st.session_state.get(f"confirm_delete_{company_idx}", False):
            # Actually delete
            company_name = company['name']  # Store name before deletion

            # Backup company files before deletion
            backup_success = backup_company_files(company)

            if backup_success:
                # Remove from organizations list
                organizations.pop(company_idx)

                # Clear any session state that might reference old indices
                keys_to_remove = [key for key in st.session_state.keys() if key.startswith('confirm_delete_')]
                for key in keys_to_remove:
                    del st.session_state[key]

                if save_organizations(organizations):
                    st.session_state[f'delete_success_{company_idx}'] = f"‚úÖ Company '{company_name}' deleted successfully! Files backed up to common/deleted_companies/"
                    # Clear cache to refresh sidebar company list
                    st.cache_data.clear()
                    st.rerun()
                else:
                    st.error("‚ùå Error deleting company from database.")
            else:
                st.error("‚ùå Error backing up company files. Deletion cancelled for safety.")
        else:
            # Show confirmation
            st.session_state[f"confirm_delete_{company_idx}"] = True
            st.warning("‚ö†Ô∏è Click delete again to confirm removal. Files will be moved to backup folder.")

    # Show delete success message below the button if it exists
    if f'delete_success_{company_idx}' in st.session_state:
        st.success(st.session_state[f'delete_success_{company_idx}'])
        del st.session_state[f'delete_success_{company_idx}']

def add_company_form(organizations: List[Dict]):
    """Form to add new company"""

    # Initialize form fields with session state for clearing
    if 'clear_form' not in st.session_state:
        st.session_state.clear_form = False

    with st.form("add_new_company", clear_on_submit=False):
        st.subheader("New Company Details")

        # Company details - use empty values when form needs to be cleared
        company_name = st.text_input(
            "Company Name *",
            value="" if st.session_state.clear_form else st.session_state.get('temp_company_name', ''),
            placeholder="Enter company name"
        )
        company_uen = st.text_input(
            "UEN *",
            value="" if st.session_state.clear_form else st.session_state.get('temp_company_uen', ''),
            placeholder="Enter UEN number"
        )
        company_address = st.text_area(
            "Address",
            value="" if st.session_state.clear_form else st.session_state.get('temp_company_address', ''),
            placeholder="Enter company address (optional)"
        )

        # Logo upload
        uploaded_logo = st.file_uploader(
            "Upload company logo",
            type=['png', 'jpg', 'jpeg'],
            help="Optional: Upload company logo",
            key="company_logo_upload"
        )

        # Template management
        st.write("Templates (Optional)")
        col1, col2 = st.columns(2)
        with col1:
            cp_template_file = st.file_uploader("Course Proposal Template", type=['docx', 'doc'], key="new_cp_template")
            assessment_template_file = st.file_uploader("Assessment Template", type=['docx', 'doc'], key="new_assessment_template")
        with col2:
            courseware_template_file = st.file_uploader("Courseware Template", type=['docx', 'doc'], key="new_courseware_template")
            brochure_template_file = st.file_uploader("Brochure Template", type=['docx', 'doc'], key="new_brochure_template")

        # Submit button
        submitted = st.form_submit_button("‚ûï Add Company", type="primary")

        if submitted:
            if company_name and company_uen:
                # Create new company
                new_company = {
                    "name": company_name,
                    "uen": company_uen,
                    "address": company_address,
                    "logo": "",
                    "templates": {
                        "course_proposal": "",
                        "courseware": "",
                        "assessment": "",
                        "brochure": ""
                    }
                }

                # Handle logo upload
                if uploaded_logo:
                    logo_path = save_company_logo(uploaded_logo, company_name)
                    if logo_path:
                        new_company["logo"] = logo_path

                # Handle template uploads
                template_files = {
                    "course_proposal": cp_template_file,
                    "courseware": courseware_template_file,
                    "assessment": assessment_template_file,
                    "brochure": brochure_template_file
                }

                for template_type, template_file in template_files.items():
                    if template_file:
                        template_path = save_company_template(template_file, company_name, template_type)
                        if template_path:
                            new_company["templates"][template_type] = template_path

                # Add to organizations
                organizations.append(new_company)

                # Save to file
                if save_organizations(organizations):
                    # Store success message to show after rerun
                    st.session_state['add_company_success'] = f"‚úÖ Company '{company_name}' added successfully!"
                    # Clear form fields by setting flag
                    st.session_state.clear_form = True
                    # Clear any temporary values
                    for key in ['temp_company_name', 'temp_company_uen', 'temp_company_address']:
                        if key in st.session_state:
                            del st.session_state[key]
                    # Clear cache to refresh sidebar company list
                    st.cache_data.clear()
                    st.rerun()
                else:
                    st.error("‚ùå Error adding company. Please try again.")
            else:
                st.error("‚ùå Please fill in required fields: Company Name and UEN")

    # Reset clear form flag after displaying empty form
    if st.session_state.clear_form:
        st.session_state.clear_form = False

    # Show success message below the form if company was just added
    if 'add_company_success' in st.session_state:
        st.success(st.session_state['add_company_success'])
        # Clear the success message after showing it
        del st.session_state['add_company_success']

# Old functions removed - now using dynamic API manager

def save_company_logo(uploaded_file, company_name: str) -> str:
    """Save uploaded logo and return path"""
    try:
        # Create logo directory if it doesn't exist
        logo_dir = "common/logo"
        os.makedirs(logo_dir, exist_ok=True)
        
        # Generate filename
        file_extension = uploaded_file.name.split('.')[-1].lower()
        clean_name = company_name.lower().replace(' ', '_').replace('/', '_').replace('\\', '_')
        filename = f"{clean_name}.{file_extension}"
        file_path = os.path.join(logo_dir, filename)
        
        # Save file
        with open(file_path, "wb") as f:
            f.write(uploaded_file.getbuffer())
        
        return file_path
    except Exception as e:
        st.error(f"Error saving logo: {e}")
        return ""

def save_company_template(uploaded_file, company_name: str, template_type: str) -> str:
    """Save uploaded template and return path"""
    try:
        # Create templates directory if it doesn't exist
        templates_dir = f"common/templates/{company_name.lower().replace(' ', '_')}"
        os.makedirs(templates_dir, exist_ok=True)
        
        # Generate filename
        file_extension = uploaded_file.name.split('.')[-1].lower()
        filename = f"{template_type}_template.{file_extension}"
        file_path = os.path.join(templates_dir, filename)
        
        # Save file
        with open(file_path, "wb") as f:
            f.write(uploaded_file.getbuffer())
        
        return file_path
    except Exception as e:
        st.error(f"Error saving {template_type} template: {e}")
        return ""

if __name__ == "__main__":
    app()